/* oxlint-disable promise/prefer-await-to-then */

'use client'

import type { Doc, Id } from '@a/be/model'
import type { FunctionReturnType } from 'convex/server'
import type { output } from 'zod/v4'

import { api } from '@a/be'
import { orgScoped } from '@a/be/t'
import { fail } from '@a/fe/utils'
import { Avatar, AvatarFallback, AvatarImage } from '@a/ui/avatar'
import { Badge } from '@a/ui/badge'
import { Button } from '@a/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@a/ui/card'
import { Checkbox } from '@a/ui/checkbox'
import { Input } from '@a/ui/input'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@a/ui/select'
import { Skeleton } from '@a/ui/skeleton'
import { useQuery } from 'convex/react'
import { EditorsSection } from 'lazyconvex/components'
import { canEditResource, useOrgMutation, useOrgQuery } from 'lazyconvex/react'
import { enumToOptions } from 'lazyconvex/zod'
import { Check, Pencil, Plus, Trash, X } from 'lucide-react'
import Link from 'next/link'
import { use, useState } from 'react'
import { toast } from 'sonner'

import { useOrg } from '~/hook/use-org'

type Member = FunctionReturnType<typeof api.org.members>[number]
type Priority = NonNullable<output<typeof orgScoped.task>['priority']>

const priorityOptions = enumToOptions(orgScoped.task.shape.priority.unwrap()),
  PrioritySelect = ({ onValueChange, value }: { onValueChange: (v: Priority) => void; value: Priority }) => (
    <Select onValueChange={v => onValueChange(v as Priority)} value={value}>
      <SelectTrigger className='w-28'>
        <SelectValue />
      </SelectTrigger>
      <SelectContent>
        {priorityOptions.map(o => (
          <SelectItem key={o.value} value={o.value}>
            {o.label}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  )

interface TaskRowProps {
  canAssign: boolean
  canEdit: boolean
  members: Member[]
  onAssign: (userId: Id<'users'> | null) => void
  onDelete: () => void
  onToggle: () => void
  onUpdate: (title: string, priority: Priority) => Promise<void>
  task: Doc<'task'>
}

const TaskRow = ({ canAssign, canEdit, members, onAssign, onDelete, onToggle, onUpdate, task: t }: TaskRowProps) => {
    const [editing, setEditing] = useState(false),
      [editTitle, setEditTitle] = useState(t.title),
      [editPriority, setEditPriority] = useState<Priority>(t.priority ?? 'medium'),
      handleSave = () => {
        if (!editTitle.trim()) return

        onUpdate(editTitle, editPriority)
          .then(() => {
            setEditing(false)
            toast.success('Task updated')
            return null
          })
          .catch(fail)
      },
      handleCancel = () => {
        setEditTitle(t.title)
        setEditPriority(t.priority ?? 'medium')
        setEditing(false)
      },
      { assigneeId } = t,
      assignee = assigneeId ? members.find(m => m.userId === assigneeId) : null

    if (editing)
      return (
        <div className='flex items-center gap-2 py-2'>
          <Input className='flex-1' onChange={e => setEditTitle(e.target.value)} value={editTitle} />
          <PrioritySelect onValueChange={setEditPriority} value={editPriority} />
          <Button onClick={handleSave} size='icon' variant='ghost'>
            <Check className='size-4 text-green-600' />
          </Button>
          <Button onClick={handleCancel} size='icon' variant='ghost'>
            <X className='size-4 text-red-600' />
          </Button>
        </div>
      )

    return (
      <div className='flex items-center gap-3 py-2'>
        <Checkbox checked={Boolean(t.completed)} disabled={!canEdit} onCheckedChange={onToggle} />
        <span className={t.completed ? 'flex-1 text-muted-foreground line-through' : 'flex-1'}>{t.title}</span>
        <span className='text-xs text-muted-foreground'>{t.priority}</span>
        {canAssign ? (
          <Select
            onValueChange={v => onAssign(members.find(m => m.userId === v)?.userId ?? null)}
            value={assigneeId ?? 'none'}>
            <SelectTrigger className='w-32'>
              <SelectValue placeholder='Unassigned' />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value='none'>Unassigned</SelectItem>
              {members.map(m => (
                <SelectItem key={m.userId} value={m.userId}>
                  {m.user?.name ?? 'Unknown'}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        ) : assignee ? (
          <div className='flex items-center gap-1'>
            <Avatar className='size-5'>
              {assignee.user?.image ? <AvatarImage src={assignee.user.image} /> : null}
              <AvatarFallback className='text-xs'>{assignee.user?.name?.[0] ?? '?'}</AvatarFallback>
            </Avatar>
            <span className='text-xs text-muted-foreground'>{assignee.user?.name}</span>
          </div>
        ) : null}
        {canEdit ? (
          <>
            <Button onClick={() => setEditing(true)} size='icon' variant='ghost'>
              <Pencil className='size-4' />
            </Button>
            <Button onClick={onDelete} size='icon' variant='ghost'>
              <Trash className='size-4' />
            </Button>
          </>
        ) : null}
      </div>
    )
  },
  ProjectDetailPage = ({ params }: { params: Promise<{ projectId: Id<'project'> }> }) => {
    const { projectId } = use(params),
      { isAdmin } = useOrg(),
      me = useQuery(api.user.me, {}),
      project = useOrgQuery(api.project.read, { id: projectId }),
      tasks = useOrgQuery(api.task.byProject, { projectId }),
      members = useOrgQuery(api.org.members),
      editorsList = useOrgQuery(api.project.editors, { projectId }),
      createTask = useOrgMutation(api.task.create),
      updateTask = useOrgMutation(api.task.update),
      removeTask = useOrgMutation(api.task.rm),
      bulkRm = useOrgMutation(api.task.bulkRm),
      bulkUpdate = useOrgMutation(api.task.bulkUpdate),
      toggleTask = useOrgMutation(api.task.toggle),
      assignTask = useOrgMutation(api.task.assign),
      addEditorMut = useOrgMutation(api.project.addEditor),
      removeEditorMut = useOrgMutation(api.project.removeEditor),
      [title, setTitle] = useState(''),
      [priority, setPriority] = useState<Priority>('medium'),
      [selected, setSelected] = useState<Set<Id<'task'>>>(new Set())

    if (!(project && tasks && me && members && editorsList)) return <Skeleton className='h-40' />

    const canEditProject = canEditResource({ editorsList, isAdmin, resource: project, userId: me._id }),
      doAddTask = async () => {
        if (!title.trim()) return
        try {
          await createTask({ completed: false, priority, projectId, title })
          setTitle('')
          toast.success('Task added')
        } catch (error) {
          fail(error)
        }
      },
      handleAddTask = (e: React.SyntheticEvent) => {
        e.preventDefault()
        doAddTask()
      },
      handleToggle = (id: Id<'task'>) => {
        toggleTask({ id }).catch(fail)
      },
      handleDeleteTask = (id: Id<'task'>) => {
        removeTask({ id })
          .then(() => toast.success('Task deleted'))
          .catch(fail)
      },
      toggleSelect = (id: Id<'task'>) => {
        setSelected(prev => {
          const next = new Set(prev)
          if (next.has(id)) next.delete(id)
          else next.add(id)
          return next
        })
      },
      toggleSelectAll = () => {
        if (selected.size === tasks.length) setSelected(new Set())
        else setSelected(new Set(tasks.map(t => t._id)))
      },
      handleBulkDelete = () => {
        if (selected.size === 0) return
        bulkRm({ ids: [...selected] })
          .then(() => {
            toast.success(`${selected.size} task(s) deleted`)
            setSelected(new Set())
            return null
          })
          .catch(fail)
      },
      handleBulkComplete = (completed: boolean) => {
        if (selected.size === 0) return
        bulkUpdate({ data: { completed }, ids: [...selected] })
          .then(() => {
            toast.success(`${selected.size} task(s) updated`)
            setSelected(new Set())
            return null
          })
          .catch(fail)
      },
      handleAddEditor = (userId: string) => {
        addEditorMut({ editorId: userId, projectId })
          .then(() => toast.success('Editor added'))
          .catch(fail)
      },
      handleRemoveEditor = (userId: string) => {
        removeEditorMut({ editorId: userId, projectId })
          .then(() => toast.success('Editor removed'))
          .catch(fail)
      }

    return (
      <div className='space-y-6'>
        <div className='flex items-center justify-between'>
          <div className='flex items-center gap-3'>
            <h1 className='text-2xl font-bold'>{project.name}</h1>
            {canEditProject ? null : <Badge variant='secondary'>View only</Badge>}
          </div>
          {canEditProject ? (
            <Button asChild variant='outline'>
              <Link href={`/projects/${projectId}/edit`}>
                <Pencil className='mr-2 size-4' />
                Edit
              </Link>
            </Button>
          ) : null}
        </div>
        {project.description ? <p className='text-muted-foreground'>{project.description}</p> : null}

        <Card>
          <CardHeader className='flex flex-row items-center justify-between'>
            <CardTitle>Tasks</CardTitle>
            {isAdmin && selected.size > 0 ? (
              <div className='flex items-center gap-2'>
                <span className='text-sm text-muted-foreground'>{selected.size} selected</span>
                <Button onClick={() => handleBulkComplete(true)} size='sm' variant='outline'>
                  Mark Complete
                </Button>
                <Button onClick={() => handleBulkComplete(false)} size='sm' variant='outline'>
                  Mark Incomplete
                </Button>
                <Button onClick={handleBulkDelete} size='sm' variant='destructive'>
                  Delete
                </Button>
              </div>
            ) : null}
          </CardHeader>
          <CardContent className='space-y-4'>
            {canEditProject ? (
              <form className='flex gap-2' onSubmit={handleAddTask}>
                <Input
                  className='flex-1'
                  onChange={e => setTitle(e.target.value)}
                  placeholder='New task...'
                  value={title}
                />
                <PrioritySelect onValueChange={setPriority} value={priority} />
                <Button type='submit'>
                  <Plus className='size-4' />
                </Button>
              </form>
            ) : null}

            <div className='divide-y'>
              {isAdmin && tasks.length > 0 ? (
                <div className='flex items-center gap-3 py-2 text-sm text-muted-foreground'>
                  <Checkbox
                    checked={selected.size === tasks.length && tasks.length > 0}
                    onCheckedChange={toggleSelectAll}
                  />
                  <span>Select all</span>
                </div>
              ) : null}
              {tasks.map(t => {
                const isTaskCreator = t.userId === me._id,
                  canEdit = isTaskCreator || canEditProject
                return (
                  <div className='flex items-center gap-2' key={t._id}>
                    {isAdmin ? (
                      <Checkbox checked={selected.has(t._id)} onCheckedChange={() => toggleSelect(t._id)} />
                    ) : null}
                    <div className='flex-1'>
                      <TaskRow
                        canAssign={canEditProject}
                        canEdit={canEdit}
                        members={members}
                        onAssign={userId => {
                          assignTask({ assigneeId: userId ?? undefined, id: t._id }).catch(fail)
                        }}
                        onDelete={() => handleDeleteTask(t._id)}
                        onToggle={() => handleToggle(t._id)}
                        onUpdate={async (newTitle, newPriority) => {
                          await updateTask({ id: t._id, priority: newPriority, title: newTitle })
                        }}
                        task={t}
                      />
                    </div>
                  </div>
                )
              })}
              {tasks.length === 0 && <p className='py-4 text-center text-muted-foreground'>No tasks yet</p>}
            </div>
          </CardContent>
        </Card>

        {isAdmin ? (
          <EditorsSection
            editorsList={editorsList}
            members={members}
            onAdd={handleAddEditor}
            onRemove={handleRemoveEditor}
          />
        ) : null}
      </div>
    )
  }

export default ProjectDetailPage
